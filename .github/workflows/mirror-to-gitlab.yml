name: Mirror to GitLab (SSH, force)

on:
  push:
    branches:
      - '**'          # run on any branch push
  workflow_dispatch:   # allow manual runs from the Actions tab

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # full history for the checked-out branch
          fetch-tags: true

      - name: Fetch all branches and tags from origin
        run: |
          # Update remote-tracking branches and tags from GitHub (origin)
          git fetch origin --prune --tags

      - name: Set up SSH for GitLab
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          # Prepare SSH directory
          install -m 700 -d ~/.ssh

          # Write private key from the GitHub secret
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Trust gitlab.ethz.ch host key
          ssh-keyscan gitlab.ethz.ch >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Configure Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Mirror branches and tags to GitLab (force)
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_ed25519"
        run: |
          # Clean up remote if it already exists
          git remote remove mirror 2>/dev/null || true

          # GitLab mirror repo
          git remote add mirror git@gitlab.ethz.ch:smec/tatva-mirror.git

          # Force-update all branches:
          #   refs/remotes/origin/* (remote-tracking branches from GitHub)
          #   â†’ refs/heads/* (normal branches on GitLab)
          git push mirror --force --prune 'refs/remotes/origin/*:refs/heads/*'

          # Force-update all tags
          git push mirror --force --prune --tags
