name: Mirror to GitLab (SSH, force)

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch all branches and tags from origin
        run: |
          # Update remote-tracking branches and tags from GitHub (origin)
          git fetch origin --prune --tags

          # Remove the remote HEAD ref so we don't try to push it as a branch named 'HEAD'
          git update-ref -d refs/remotes/origin/HEAD || true

      - name: Set up SSH for GitLab
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          install -m 700 -d ~/.ssh

          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan gitlab.ethz.ch >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Configure Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Mirror branches and tags to GitLab (force)
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_ed25519"
        run: |
          git remote remove mirror 2>/dev/null || true
          git remote add mirror git@gitlab.ethz.ch:smec/tatva-mirror.git

          # Force-update all branches from origin/* to GitLab branches
          git push mirror --force --prune 'refs/remotes/origin/*:refs/heads/*'

          # Force-update all tags
          git push mirror --force --prune --tags
